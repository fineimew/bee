<!DOCTYPE html><html lang="en"><head><meta charSet="utf-8"/><meta http-equiv="X-UA-Compatible" content="IE=edge"/><title>Using Docker on Emilia · Open Power Quality</title><meta name="viewport" content="width=device-width"/><meta name="generator" content="Docusaurus"/><meta name="description" content="## Overview"/><meta name="docsearch:language" content="en"/><meta property="og:title" content="Using Docker on Emilia · Open Power Quality"/><meta property="og:type" content="website"/><meta property="og:url" content="https://openpowerquality.org/index.html"/><meta property="og:description" content="## Overview"/><meta name="twitter:card" content="summary"/><link rel="shortcut icon" href="/img/opq.ico"/><link rel="stylesheet" href="https://cdn.jsdelivr.net/docsearch.js/1/docsearch.min.css"/><link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/default.min.css"/><link rel="alternate" type="application/atom+xml" href="https://openpowerquality.org/blog/atom.xml" title="Open Power Quality Blog ATOM Feed"/><link rel="alternate" type="application/rss+xml" href="https://openpowerquality.org/blog/feed.xml" title="Open Power Quality Blog RSS Feed"/><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Gugi"/><script type="text/javascript" src="https://buttons.github.io/buttons.js"></script><script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.4/MathJax.js?config=TeX-MML-AM_CHTML"></script><script type="text/javascript" src="/js/mathjax-config.js"></script><script src="/js/scrollSpy.js"></script><link rel="stylesheet" href="/css/main.css"/><script src="/js/codetabs.js"></script></head><body class="sideNavVisible separateOnPageNav"><div class="fixedHeaderContainer"><div class="headerWrapper wrapper"><header><a href="/"><img class="logo" src="/img/opqlogo_white.png" alt="Open Power Quality"/><h2 class="headerTitleWithLogo">Open Power Quality</h2></a><div class="navigationWrapper navigationSlider"><nav class="slidingNav"><ul class="nav-site nav-site-internal"><li class=""><a href="/docs/intro-motivation.html" target="_self">Documentation</a></li><li class=""><a href="/docs/other-opportunities.html" target="_self">Opportunities</a></li><li class=""><a href="/blog/" target="_self">News</a></li><li class="navSearchWrapper reactNavSearchWrapper"><input type="text" id="search_input_react" placeholder="Search" title="Search"/></li></ul></nav></div></header></div></div><div class="navPusher"><div class="docMainWrapper wrapper"><div class="container mainContainer"><div class="wrapper"><div class="post"><header class="postHeader"><h1 class="postHeaderTitle">Using Docker on Emilia</h1></header><article><div><span><h2><a class="anchor" aria-hidden="true" id="overview"></a><a href="#overview" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Overview</h2>
<p>We utilize <a href="https://www.docker.com/">Docker</a> and <a href="https://docs.docker.com/compose/">Docker Compose</a> to containerize and deploy the OPQ Services: View, Mauka, Makai, Health, and Box Updater.  For Mongo, we use the official Mongo image without modification.</p>
<h3><a class="anchor" aria-hidden="true" id="docker-and-docker-compose-installation"></a><a href="#docker-and-docker-compose-installation" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Docker and Docker Compose Installation</h3>
<p>Make sure you have Docker and Docker-Compose installed on your development and production systems.</p>
<p>Please refer to the official <a href="https://docs.docker.com/install/">Docker documentation</a> for installation instructions.</p>
<p>Also see the official <a href="https://docs.docker.com/compose/install/">Docker-Compose documentation</a>.</p>
<h2><a class="anchor" aria-hidden="true" id="deployment"></a><a href="#deployment" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Deployment</h2>
<p>Before we begin, make sure you have Docker and Docker-Compose installed on your production system.</p>
<p>The <code>opq/util/docker-deployment</code> directory contains all the files required for deployment.</p>
<p>Ensure that you have the latest versions of these files by pulling the latest changes on the master branch of the OPQ GitHub repository.
By doing so, you also ensure that your deployment will be running on all the latest available OPQ docker images.</p>
<p>Deployment is a very straight-forward process:</p>
<ol>
<li>Transfer the latest contents of the <code>opq/util/docker-deployment</code> directory into a dedicated deployment directory of your choice on your production server, overwriting all previous deployment files.</li>
<li>Ensure that the <code>settings.production.json</code> file is also placed in your dedicated deployment directory.</li>
<li>Invoke the <code>docker-compose-run.sh</code> script to re-deploy the OPQ Cloud instance.</li>
</ol>
<p>This is essentially all that is required to deploy your own OPQ Cloud instance.</p>
<p>However, OPQ developers deploying on the Emilia server can (and should) use the helper scripts we provide to streamline
this entire process. The deployment walk-through below details this further.</p>
<h3><a class="anchor" aria-hidden="true" id="deployment-walk-through"></a><a href="#deployment-walk-through" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Deployment Walk-through</h3>
<p>Note: This deployment walk-through is specific for OPQ developers deploying on the Emilia server.</p>
<h4><a class="anchor" aria-hidden="true" id="transfer-deployment-files-to-production-server"></a><a href="#transfer-deployment-files-to-production-server" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Transfer deployment files to production server</h4>
<p>Invoke the <code>deploy-transfer.sh</code> script found in the <code>opq/util/docker-utils</code> directory.</p>
<p>This script creates a timestamp-named directory, copies the contents of the <code>opq/util/docker-deployment</code> directory into it (as well as the <code>docker-prepare-and-run.sh</code> helper script),
gzips the new directory, and then secure copies it to the Emilia server under the <code>/home/opquser/docker/transfers</code> directory.</p>
<pre><code class="hljs">$ ./deploy-transfer.sh
<span class="hljs-addition">++ date +%Y%m%d_%H%M%S</span>
<span class="hljs-addition">+ timestamp=20190219_123528</span>
<span class="hljs-addition">+ mkdir 20190219_123528</span>
<span class="hljs-addition">+ cp ../docker-deployment/docker-compose.yml 20190219_123528</span>
<span class="hljs-addition">+ cp ../docker-deployment/docker-compose-run.sh 20190219_123528</span>
<span class="hljs-addition">+ cp ../docker-deployment/.env 20190219_123528</span>
<span class="hljs-addition">+ cp docker-prepare-and-run.sh 20190219_123528</span>
<span class="hljs-addition">+ tar czf 20190219_123528.tar.gz 20190219_123528</span>
<span class="hljs-addition">+ rm -rf 20190219_123528</span>
<span class="hljs-addition">+ EMILIA_DOCKER_TRANSFER_DIR=/home/opquser/docker/transfers</span>
<span class="hljs-addition">+ scp -P 29862 20190219_123528.tar.gz opquser@emilia.ics.hawaii.edu:/home/opquser/docker/transfers</span>
opquser@emilia.ics.hawaii.edu's password:
20190219_123528.tar.gz                                                                                                                                                                                      100% 2169     2.1KB/s   00:01
<span class="hljs-addition">+ set +x</span>
</code></pre>
<h4><a class="anchor" aria-hidden="true" id="extract-deployment-files-on-production-server"></a><a href="#extract-deployment-files-on-production-server" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Extract deployment files on production server</h4>
<p>Now we need to unpack the deployment files that we had just transferred.</p>
<p>First, ssh to the server with the proper credentials:</p>
<pre><code class="hljs">ssh -<span class="hljs-selector-tag">p</span> <span class="hljs-number">29862</span> opquser@emilia<span class="hljs-selector-class">.ics</span><span class="hljs-selector-class">.hawaii</span><span class="hljs-selector-class">.edu</span>
</code></pre>
<p>Change into the <code>docker/transfers</code> subdirectory, and list the files:</p>
<pre><code class="hljs"><span class="hljs-symbol">opquser@</span>emilia:~$ cd docker/transfers
<span class="hljs-symbol">opquser@</span>emilia:~/docker/transfers$ ls -al
total <span class="hljs-number">20</span>
drwxr-xr-x <span class="hljs-number">3</span> opquser opquser <span class="hljs-number">4096</span> Feb <span class="hljs-number">19</span> <span class="hljs-number">07</span>:<span class="hljs-number">38</span> .
drwxr-xr-x <span class="hljs-number">4</span> opquser opquser <span class="hljs-number">4096</span> Feb <span class="hljs-number">18</span> <span class="hljs-number">17</span>:<span class="hljs-number">40</span> ..
drwxr-xr-x <span class="hljs-number">2</span> opquser opquser <span class="hljs-number">4096</span> Feb <span class="hljs-number">18</span> <span class="hljs-number">17</span>:<span class="hljs-number">00</span> <span class="hljs-number">20190206</span>_144024
-rw-r--r-- <span class="hljs-number">1</span> opquser opquser <span class="hljs-number">1201</span> Feb <span class="hljs-number">18</span> <span class="hljs-number">15</span>:<span class="hljs-number">25</span> <span class="hljs-number">20190206</span>_144024.tar.gz
-rw-r--r-- <span class="hljs-number">1</span> opquser opquser <span class="hljs-number">2169</span> Feb <span class="hljs-number">19</span> <span class="hljs-number">07</span>:<span class="hljs-number">35</span> <span class="hljs-number">20190219</span>_123528.tar.gz
</code></pre>
<p>You may see one or more timestamped tar.gz files and directories. Each of these correspond to a previous deployment transfer.
While it's generally a good idea to keep this directory clean, it can be useful to keep at least one previous deployment in this directory to fall back on, just in case a problem is encountered with the latest deployment.</p>
<p>The most recently timestamped tar.gz file will be the one that you had just transferred over.
Extract it:</p>
<pre><code class="hljs">opquser<span class="hljs-variable">@emilia</span><span class="hljs-symbol">:~/docker/transfers</span><span class="hljs-variable">$ </span>tar xf <span class="hljs-number">20190219_123528</span>.tar.gz
</code></pre>
<p>Change into the extracted directory and list all files:</p>
<pre><code class="hljs"><span class="hljs-symbol">opquser@</span>emilia:~/docker/transfers$ cd <span class="hljs-number">20190219</span>_123528
<span class="hljs-symbol">opquser@</span>emilia:~/docker/transfers/<span class="hljs-number">20190219</span>_123528$ ls -al
total <span class="hljs-number">24</span>
drwxr-xr-x <span class="hljs-number">2</span> opquser opquser <span class="hljs-number">4096</span> Feb <span class="hljs-number">19</span> <span class="hljs-number">07</span>:<span class="hljs-number">35</span> .
drwxr-xr-x <span class="hljs-number">4</span> opquser opquser <span class="hljs-number">4096</span> Feb <span class="hljs-number">19</span> <span class="hljs-number">07</span>:<span class="hljs-number">40</span> ..
-rwxr-xr-x <span class="hljs-number">1</span> opquser opquser  <span class="hljs-number">571</span> Feb <span class="hljs-number">19</span> <span class="hljs-number">07</span>:<span class="hljs-number">35</span> docker-compose-run.sh
-rw-r--r-- <span class="hljs-number">1</span> opquser opquser <span class="hljs-number">2463</span> Feb <span class="hljs-number">19</span> <span class="hljs-number">07</span>:<span class="hljs-number">35</span> docker-compose.yml
-rwxr-xr-x <span class="hljs-number">1</span> opquser opquser  <span class="hljs-number">591</span> Feb <span class="hljs-number">19</span> <span class="hljs-number">07</span>:<span class="hljs-number">35</span> docker-prepare-<span class="hljs-keyword">and</span>-run.sh
-rw-r--r-- <span class="hljs-number">1</span> opquser opquser <span class="hljs-number">2258</span> Feb <span class="hljs-number">19</span> <span class="hljs-number">07</span>:<span class="hljs-number">35</span> .env
</code></pre>
<p>You might be surprised how few files we have here, but that is the beauty of Docker and Docker-Compose.
Since the OPQ images are hosted on DockerHub, Docker will simply pull them from the cloud if they have not been downloaded yet on the host system.</p>
<h4><a class="anchor" aria-hidden="true" id="run-the-new-opq-cloud-instance"></a><a href="#run-the-new-opq-cloud-instance" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Run the new OPQ Cloud instance</h4>
<p>Finally, invoke the <code>docker-prepare-and-run.sh</code> script to deploy the latest OPQ Cloud instance:</p>
<pre><code class="hljs">opquser@emilia:~/docker/transfers/<span class="hljs-number">20190219</span>_123528<span class="hljs-symbol">$</span> ./docker-prepare-<span class="hljs-keyword">and</span>-run.sh
<span class="hljs-function"><span class="hljs-title">Creating</span></span> deployment_boxupdateserver_1 ... done
<span class="hljs-function"><span class="hljs-title">Creating</span></span> deployment_mongo_1           ... done
<span class="hljs-function"><span class="hljs-title">Creating</span></span> deployment_view_1            ... done
<span class="hljs-function"><span class="hljs-title">Creating</span></span> deployment_mauka_1           ... done
<span class="hljs-function"><span class="hljs-title">Creating</span></span> deployment_health_1          ... done
</code></pre>
<p>We're deployed! The <code>docker-prepare-and-run.sh</code> file is a simple helper script that does two things for us:</p>
<ol>
<li>Copies the extracted deployment files to our dedicated deployment directory at <code>/home/opquser/docker/deployment</code>, overwriting previous deployment files as necessary.</li>
<li>Invokes the Docker-Compose run script <code>docker-compose-run.sh</code> to (re)deploy the OPQ Cloud instance. Docker-Compose is intelligent enough to detect the difference of deployment files and will only re-deploy the necessary services for us.</li>
</ol>
<p>You may verify that the Docker containers are up and running with the <code>docker ps</code> command.</p>
</span></div></article></div><div class="docs-prevnext"></div></div></div><nav class="onPageNav"><ul class="toc-headings"><li><a href="#overview">Overview</a><ul class="toc-headings"><li><a href="#docker-and-docker-compose-installation">Docker and Docker Compose Installation</a></li></ul></li><li><a href="#deployment">Deployment</a><ul class="toc-headings"><li><a href="#deployment-walk-through">Deployment Walk-through</a></li></ul></li></ul></nav></div><footer class="nav-footer" id="footer"><section class="sitemap"><a href="/" class="nav-home"><img src="/img/opqlogo_white.png" alt="Open Power Quality" width="66" height="58"/></a><div><h5>Documentation Quick Links</h5><a href="/docs/intro-opq.html">Overview</a><a href="/docs/userguide-hardware.html">OPQ Box User Guide</a><a href="/docs/userguide-software.html">OPQ View User Guide</a><a href="/docs/other-agile-power-monitoring.html">Agile Power Monitoring for UH</a><a href="/docs/other-roadmap.html">Roadmap</a></div><div><h5>Community</h5><a href="https://openpowerquality.slack.com/" target="_blank" rel="noreferrer noopener">Slack</a><a href="https://twitter.com/opquality" target="_blank" rel="noreferrer noopener">Twitter</a><a href="/blog">News</a><a href="https://ics02.colo.hawaii.edu/">Public OPQ Cloud</a><a href="/contact-us.html">Contact Us</a></div><div><h5>Development</h5><a href="https://github.com/openpowerquality">GitHub</a><a href="https://github.com/openpowerquality/opq/projects">Project Boards</a><a href="/team.html">Developer Team</a><a href="/docs/opportunities.html">Opportunities</a></div></section><p style="text-align:center;color:#e9faff">Open Power Quality is sponsored by:<br/><a style="text-align:center;color:#e9faff" href="http://csdl.ics.hawaii.edu">Collaborative Software Development Laboratory, University of Hawaii</a><br/><a style="text-align:center;color:#e9faff" href="http://www.ics.hawaii.edu">Department of Information and Computer Sciences, University of Hawaii</a><br/><a style="text-align:center;color:#e9faff" href="http://ee.hawaii.edu">Department of Electrical Engineering, University of Hawaii</a><br/></p></footer></div><script type="text/javascript" src="https://cdn.jsdelivr.net/docsearch.js/1/docsearch.min.js"></script><script>
                document.addEventListener('keyup', function(e) {
                  if (e.target !== document.body) {
                    return;
                  }
                  // keyCode for '/' (slash)
                  if (e.keyCode === 191) {
                    const search = document.getElementById('search_input_react');
                    search && search.focus();
                  }
                });
              </script><script>
              var search = docsearch({
                
                apiKey: '9bf16cc78135dbeeb3826894ebbbb2ee',
                indexName: 'openpowerquality',
                inputSelector: '#search_input_react'
              });
            </script></body></html>